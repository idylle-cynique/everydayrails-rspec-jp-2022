# Everyday Rails Rspec Chapter.03

## この章でテストすること
 - 有効な属性で初期化された場合は、モデルの状態が有効（valid）になっていること
 - バリデーションを失敗させるデータであれば、モデルの状態が有効になっていないこと
 - クラスメソッドとインスタンスメソッドが期待通りに動作すること


## メモ

 > 古いバージョンのRails では、Rake タスクを使って開発⽤データベースの構造を⼿作
業でテストデータベースコピーにする必要がありました。しかし、現在ではマイグ
レーションを実⾏すると、Rails がこのコピー作業を(ほぼ毎回) ⾃動的に処理してく
れます。もしテスト環境でマイグレーションが未実⾏になっているというエラーが
出た場合は、bin/rails db:migrate RAILS_ENV=test というコマンドを実⾏してデー
タベースの構造を最新にしてください。


```Ruby
validates :name, presence: true, uniqueness: { scope: :user_id }
```
 - `name`カラムには必ず値が存在すること



 - `expect`メソッドで値を入れたRSpec用のオブジェクトを作成する
 - RSpecオブジェクト内の`to`メソッドを使い、論理値を返すようなメソッドと引数を別途与える


p.45  
この機能はNote モデルにスコープとして実装されています。
```
app/models/note.rb
  scope :search, ->(term) {
    where("LOWER(message) LIKE ?", "%#{term.downcase}%")
  }
```
ではNote モデル⽤に3つめのファイルをテストスイートに追加しましょう。rspec:modelジェネレータでファイルを作ったら、最初のテストを追加してください。


 - `rails generate rspec:model 'model'`コマンドで同名のモデルに対応するRSpecテストスイートを生成する。
 - テストスイートとして生成されるファイルは`spec/models/'modelname'_spec.rb`に生成されている。


### マッチャー
  - be_valid
    - 引数にRailsのモデル(ActiveRecord)を与え、そのモデルが事前に設定したモデルのバリデーション要件を満たしているかどうかを判定する
  - be_empty
    - expect()に与えたオブジェクトが空かどうかを判定する
  - include
    - expect()内のオブジェクトに、include()の引数として与えた値が存在しているかどうかを判定する
  - eq
    - eq()内に与えた引数の値が元のオブジェクトの値と等しいか判定する


describe > context 


### RSpecフック
基本的には `before(:example) / before(:each)` が推奨される。その他 `after()`もある。

 - before(:all) / before(:context)
   -  
 - before(:example) / before(:each)
   - beforeが記述されているブロックと同階層のブロック内にネストされている各テストの実行前に処理が行われる。
 - before(:suite)
   - テストスイートにおける各テストファイルのテスト実行前に処理が行われる。

### まとめ
 - 在るメソッドの実行によって期待される結果は明示的に記述し、何が問題になるかをはっきりさせること
 - テストでは、「起きてほしいこと」「起きてほしくないこと」の2点をテストする
 - 境界値(コーナーケース)のテストを行う
 - テストコードの可読性を挙げるためにスペックの整理やメンテナンスを行うこと。テストコードについてもDRY原則は重要

